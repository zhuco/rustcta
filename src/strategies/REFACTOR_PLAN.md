# 模块化重构计划（Automated Scalping / Avellaneda-Stoikov / Poisson Market Maker / Trend Grid V2）

## 1. 现状评估
- 代码体量巨大：4 个策略文件合计约 8.9k 行，单文件 1k~2.7k 行，不利于维护与单元测试。
- 模块耦合严重：配置定义、运行状态、指标计算、下单执行、风控、IO/WebSocket 管理混杂在同一文件内，难以复用。
- 可复用逻辑重复：账户信息、订单簿与行情缓存、日志/监控、风险管理、指标计算等存在大量类似实现。
- 可观测性散乱：日志、监控、策略状态输出分散且缺乏统一接口，集成到上层 CTA 模块困难。
- 抽象接口缺失：虽然存在 `Strategy` trait，但具体策略未统一实现分层职责，异步任务（WebSocket、行情、下单）控制逻辑难以替换或扩展。

## 2. 重构目标
- **结构化**：为每个策略建立独立目录与子模块，按照配置、状态、引擎、任务调度、适配层拆分。
- **复用性**：提炼公共组件（配置加载、指标计算、风险控制、订单管理、数据源适配），降低重复代码。
- **可测试性**：将纯逻辑从异步/IO 层剥离，便于编写单元测试与集成测试。
- **可观测性**：统一日志、指标、状态输出接口，确保策略可被 CTA 框架一致调用。
- **向后兼容**：保留对现有配置文件与上层调用接口的兼容，重构过程中持续验证。

## 3. 备份方案
1. 在 `src/strategies` 下创建 `backup_pre_modularization/` 目录。
2. 将四个原始文件复制到该目录中（保留时间戳或 Git commit 号命名）。
   ```bash
   mkdir -p src/strategies/backup_pre_modularization
   cp src/strategies/{automated_scalping.rs,avellaneda_stoikov.rs,poisson_market_maker.rs,trend_grid_v2.rs} \
      src/strategies/backup_pre_modularization/
   ```
3. 备份完成后再开始重构，确保可以随时对比/回滚。
4. 变更期间保持 Git 提交粒度清晰，建议使用功能分支。

## 4. 总体步骤
- **阶段 0：基线与验证**
  - 运行现有测试/集成脚本，记录当前行为基准。
  - 明确外部依赖（AccountManager、Exchange、WebSocket 客户端等）的接口契约。
- **阶段 1：目录与模块拆分**
  - 为每个策略创建子目录：`src/strategies/<strategy_name>/`。
  - 拆分出最小可行的 `mod.rs`，新增 `config.rs`（配置结构）、`state.rs`（运行状态）、`engine.rs`（核心算法）、`services.rs`（与外部依赖交互）、`tasks.rs`（异步任务管理）等文件。
  - 将 `mod.rs` 暴露的公开接口限制在构造器 + 对外 trait 实现。
- **阶段 2：公共组件提炼**
  - 抽取共用的数据结构与逻辑至 `src/strategies/common/` 或更合适的上层模块：
    - 行情/订单簿缓存抽象
    - 风险与库存管理工具
    - 指标计算（EMA、RSI、VWAP、ATR 等）与趋势识别
    - 下单/撤单封装与订单 ID 生成
    - WebSocket 与 REST 客户端包装器（统一重连、限速控制）
  - 确保这些组件具备良好单元测试覆盖。
- **阶段 3：策略内聚与接口实现**
  - 将核心算法逻辑迁移到 `engine.rs` 或 `logic.rs`，并以纯逻辑函数形式暴露。
  - 新建 `controller`/`runner` 层负责调度数据流与调用引擎。
  - 统一实现 `Strategy` trait，确保对外行为不变。
- **阶段 4：集成与验证**
  - 更新 `src/strategies/mod.rs`，导出新的模块结构。
  - 补充或修正单元/集成测试，验证四个策略功能。
  - 回归测试 + 性能验证，关注并发、安全性、精度。
  - 审查日志、指标输出是否符合 CTA 框架要求。

## 5. 各策略重点
- **Automated Scalping**
  - 拆分指标计算（EMA/RSI/VWAP/ATR）与订单簿处理。
  - 提炼高频下单节流与请求权重逻辑，复用到其它策略。
  - 重构 `ASStrategyState`，将账户仓位、订单管理、统计数据拆分成独立结构。
- **Avellaneda-Stoikov**
  - 将模型参数计算、库存偏斜、价差计算拆出 `engine`。
  - 独立行情队列与风险控制模块，完善定价函数测试。
  - 重构 WebSocket 管理与订单生命周期，减少直接依赖具体交易所实现。
- **Poisson Market Maker**
  - 提炼泊松参数估计到独立模块，并与订单流事件队列解耦。
  - 抽象订单流事件来源，复用到可能的回测/模拟环境。
  - 加强风险控制与价差调整的配置校验。
- **Trend Grid V2**
  - 独立趋势识别引擎（多时间框指标），与网格生成逻辑分层。
  - 拆分批量下单/撤单适配层，支持多交易所批量策略。
  - 将日志与文件写入（当前使用本地文件）统一为可配置输出。

## 6. 风险与对策
- **行为回归**：逐步迁移，保持配置与外部接口不变；重构后运行回归测试。
- **并发/异步问题**：拆分后需重新审视锁粒度与异步任务生命周期，强化单元测试 + tokio 测试。
- **配置兼容性**：为新增模块保留 `serde` 派生，设计向后兼容的配置加载。
- **开发流程**：分阶段提交、代码评审；避免一次性大合并。

## 7. 验证清单
- 单元测试覆盖各核心算法（价差、指标、风险控制）。
- 集成测试验证下单、撤单、行情处理流程。
- 静态检查（`cargo fmt`, `cargo clippy`）通过。
- 日志/监控输出符合预期，策略状态查询正常。

读取此计划后，如无异议，再按上述顺序执行重构。
